#!/usr/bin/env bash
#
# golem - Personal agentic workflow manager
#
# Integrates Freshworks tickets, Gitea issues, and Claude Code
# for a unified development workflow.
#

set -euo pipefail

VERSION="2.1.0"
GOLEM_HOME="${GOLEM_HOME:-$HOME/.golem}"
GOLEM_API="golem-api"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[0;90m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ============================================================================
# Helpers
# ============================================================================

print_banner() {
  echo -e "${CYAN}"
  echo "   ██████╗  ██████╗ ██╗     ███████╗███╗   ███╗"
  echo "  ██╔════╝ ██╔═══██╗██║     ██╔════╝████╗ ████║"
  echo "  ██║  ███╗██║   ██║██║     █████╗  ██╔████╔██║"
  echo "  ██║   ██║██║   ██║██║     ██╔══╝  ██║╚██╔╝██║"
  echo "  ╚██████╔╝╚██████╔╝███████╗███████╗██║ ╚═╝ ██║"
  echo "   ╚═════╝  ╚═════╝ ╚══════╝╚══════╝╚═╝     ╚═╝"
  echo -e "${NC}"
}

die() {
  echo -e "${RED}Error:${NC} $1" >&2
  exit 1
}

info() {
  echo -e "${BLUE}→${NC} $1"
}

success() {
  echo -e "${GREEN}✓${NC} $1"
}

warn() {
  echo -e "${YELLOW}!${NC} $1"
}

dim() {
  echo -e "${DIM}$1${NC}"
}

# Load environment from multiple locations (safely handles special chars)
load_env() {
  local env_file
  for env_file in "$GOLEM_HOME/.env" ".env"; do
    if [[ -f "$env_file" ]]; then
      while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
        # Remove leading/trailing whitespace from key
        key="${key#"${key%%[![:space:]]*}"}"
        key="${key%"${key##*[![:space:]]}"}"
        # Skip if not a valid variable name
        [[ ! "$key" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]] && continue
        # Export the variable (value keeps quotes if present)
        export "$key=$value"
      done < "$env_file"
    fi
  done
}

# Check if golem-api is available
check_api() {
  if ! command -v "$GOLEM_API" &>/dev/null; then
    die "golem-api not found. Run 'pnpm build' in golem directory first."
  fi
}

# Get current ticket ID from worktree path
get_current_ticket() {
  local branch
  branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
  echo "$branch" | grep -oE '(INC|SR)-[0-9]+' || echo ""
}

# ============================================================================
# Commands
# ============================================================================

cmd_help() {
  print_banner
  cat << 'EOF'
USAGE:
    golem <command> [options]

TICKET COMMANDS:
    new <subject>         Create new ticket in Fresh + Gitea
    import <INC-XXXX>     Import existing Fresh ticket
    list                  List all tracked tickets
    status [ticket]       Show ticket status

WORKTREE COMMANDS:
    worktree [ticket]     Create/switch to worktree for ticket
    worktrees             List all worktrees

BUILD COMMANDS:
    build                 Run autonomous build loop (spawns Claude)
    plan                  Generate implementation plan
    simplify [files]      Run code simplifier
    squash                Squash current stage commits

SYNC COMMANDS:
    sync                  Sync ticket status to Fresh/Gitea
    pr                    Create PR for current ticket

OTHER:
    install               Install/update golem globally
    uninstall             Remove golem completely
    config                Show current configuration
    doctor                Diagnose setup issues
    init                  Initialize golem in current project
    version               Show version
    help                  Show this help

CLAUDE COMMANDS (inside Claude Code):
    /golem:spec           Define specs (agent team: UX, Architect, Devil's Advocate)
    /golem:plan           Create implementation plan (agent team per layer)
    /golem:build          Build lead + builders (observable, interruptible)
    /golem:security       Run security scans (gitleaks, semgrep, pnpm audit, trivy)
    /golem:review         Security + code review (runs security first, then agent team)
    /golem:simplify       Run code simplifier
    /golem:status         Show current status
    /golem:help           Show help

EOF
}

cmd_version() {
  print_banner
  echo "  v$VERSION"
}

cmd_init() {
  print_banner

  # Validate global installation
  if [[ ! -d "$GOLEM_HOME/lib" ]]; then
    warn "Golem is not installed globally."
    echo "  Run: pnpm dlx golem-cc"
    echo ""
  fi

  info "Initializing golem in current project..."

  mkdir -p .golem/{specs,tickets,worktrees}

  if [[ ! -f .golem/AGENTS.md ]]; then
    cat > .golem/AGENTS.md << 'EOF'
# Operational Guide

## Commands

### Testing
```bash
pnpm test
```

### Type Checking
```bash
pnpm typecheck
```

### Linting
```bash
pnpm lint
```

## Learnings
<!-- Updated during build iterations -->
EOF
    success "Created .golem/AGENTS.md"
  fi

  # Link commands to Claude
  mkdir -p .claude/commands
  if [[ -d "$GOLEM_HOME/commands/golem" ]]; then
    ln -sf "$GOLEM_HOME/commands/golem" .claude/commands/golem 2>/dev/null || true
    success "Linked Claude commands"
  else
    warn "Claude commands not found (install golem globally first)"
  fi

  # Add .golem to .gitignore
  if [[ -f .gitignore ]]; then
    if ! grep -q "^\.golem/worktrees" .gitignore 2>/dev/null; then
      echo -e "\n# Golem worktrees\n.golem/worktrees/" >> .gitignore
      success "Updated .gitignore"
    fi
  fi

  success "Golem initialized"
}

cmd_new() {
  local subject="${1:-}"
  [[ -z "$subject" ]] && die "Usage: golem new <subject>"

  print_banner
  check_api
  load_env

  local repo="${GITEA_REPO:-}"
  [[ -z "$repo" ]] && die "GITEA_REPO not set"

  echo -e "${BOLD}Creating new ticket${NC}"
  echo ""

  read -p "Type (feat/fix/refactor/docs/test/chore) [fix]: " type
  type="${type:-fix}"

  read -p "Slug (for branch name): " slug
  [[ -z "$slug" ]] && die "Slug required"

  read -p "Description (optional): " description
  description="${description:-$subject}"

  read -p "Priority (1=Urgent, 2=High, 3=Medium, 4=Low) [3]: " priority
  priority="${priority:-3}"

  info "Creating ticket..."
  $GOLEM_API ticket:new \
    --subject "$subject" \
    --description "$description" \
    --type "$type" \
    --slug "$slug" \
    --priority "$priority" \
    --repo "$repo"
}

cmd_import() {
  local ticket_id="${1:-}"
  [[ -z "$ticket_id" ]] && die "Usage: golem import <INC-XXXX>"

  print_banner
  check_api
  load_env

  local repo="${GITEA_REPO:-}"
  [[ -z "$repo" ]] && die "GITEA_REPO not set"

  echo -e "${BOLD}Importing ticket $ticket_id${NC}"
  echo ""

  read -p "Type (feat/fix/refactor/docs/test/chore) [fix]: " type
  type="${type:-fix}"

  read -p "Slug (for branch name): " slug
  [[ -z "$slug" ]] && die "Slug required"

  info "Importing..."
  $GOLEM_API ticket:import "$ticket_id" \
    --type "$type" \
    --slug "$slug" \
    --repo "$repo"
}

cmd_list() {
  check_api
  load_env
  $GOLEM_API ticket:list
}

cmd_status() {
  local ticket_id="${1:-$(get_current_ticket)}"

  print_banner

  if [[ -z "$ticket_id" ]]; then
    # Show general status
    echo -e "${BOLD}Status${NC}"
    echo ""

    if [[ -d .golem ]]; then
      local spec_count=$(ls .golem/specs/*.md 2>/dev/null | wc -l | tr -d ' ')
      echo "Specs: $spec_count"

      if [[ -f .golem/IMPLEMENTATION_PLAN.md ]]; then
        local total=$(grep -cE '^(###|-) \[' .golem/IMPLEMENTATION_PLAN.md 2>/dev/null || echo 0)
        local done=$(grep -cE '^(###|-) \[x\]' .golem/IMPLEMENTATION_PLAN.md 2>/dev/null || echo 0)
        echo "Tasks: $done / $total"
      else
        dim "No implementation plan"
      fi
    else
      warn "Not a golem project. Run 'golem init'"
    fi
  else
    check_api
    load_env
    $GOLEM_API ticket:get "$ticket_id"
  fi
}

cmd_worktree() {
  local ticket_id="${1:-$(get_current_ticket)}"
  [[ -z "$ticket_id" ]] && die "Usage: golem worktree <INC-XXXX> or run from ticket branch"

  check_api
  load_env

  info "Creating worktree for $ticket_id..."
  local output
  output=$($GOLEM_API worktree:create "$ticket_id" 2>&1) || {
    echo "$output" >&2
    die "Failed to create worktree"
  }

  local path
  path=$(echo "$output" | tail -1)

  success "Worktree created at $path"
  echo ""
  echo "To switch to it:"
  echo "  cd $path"
}

cmd_worktrees() {
  check_api
  $GOLEM_API worktree:list
}

cmd_build() {
  local ticket_id
  ticket_id=$(get_current_ticket)

  print_banner

  [[ -z "$ticket_id" ]] && warn "Not in a ticket worktree"

  if [[ ! -f .golem/IMPLEMENTATION_PLAN.md ]]; then
    die "No implementation plan. Run /golem:plan in Claude first."
  fi

  local remaining
  remaining=$(grep -cE '^(###|-) \[ \]' .golem/IMPLEMENTATION_PLAN.md 2>/dev/null || echo 0)

  if [[ "$remaining" -eq 0 ]]; then
    success "All tasks complete!"
    return 0
  fi

  info "Starting build loop ($remaining tasks remaining)"
  echo ""

  read -p "Continue? [y/N] " confirm
  [[ "$confirm" != "y" && "$confirm" != "Y" ]] && exit 0

  # Build the prompt from the build command file
  local build_prompt
  build_prompt=$(cat "$GOLEM_HOME/prompts/PROMPT_build.md")

  # Loop until done
  while true; do
    remaining=$(grep -cE '^(###|-) \[ \]' .golem/IMPLEMENTATION_PLAN.md 2>/dev/null || echo 0)

    if [[ "$remaining" -eq 0 ]]; then
      success "All tasks complete!"
      break
    fi

    info "Tasks remaining: $remaining"
    info "Running Claude (print mode)..."
    echo ""

    # Run Claude in print mode with the build prompt
    # --dangerously-skip-permissions allows tool use without confirmation
    claude -p "$build_prompt" --dangerously-skip-permissions || true

    echo ""
    read -p "Continue to next task? [Y/n] " continue_choice
    [[ "$continue_choice" == "n" || "$continue_choice" == "N" ]] && break
  done
}

cmd_plan() {
  print_banner

  if [[ ! -d .golem/specs ]] || [[ -z "$(ls .golem/specs/*.md 2>/dev/null)" ]]; then
    die "No specs found. Run /golem:spec in Claude first."
  fi

  info "Running Claude to generate plan..."

  local plan_prompt
  plan_prompt=$(cat "$GOLEM_HOME/prompts/PROMPT_plan.md")

  claude -p "$plan_prompt" --dangerously-skip-permissions
}

cmd_simplify() {
  print_banner

  local files="${*:-}"

  info "Running code simplifier..."

  local simplify_prompt
  simplify_prompt=$(cat "$GOLEM_HOME/agents/code-simplifier.md")

  if [[ -n "$files" ]]; then
    simplify_prompt="$simplify_prompt

Files to simplify: $files"
  fi

  claude -p "$simplify_prompt" --dangerously-skip-permissions
}

cmd_squash() {
  local ticket_id message=""
  ticket_id=$(get_current_ticket)
  [[ -z "$ticket_id" ]] && die "Not in a ticket worktree"

  # Parse arguments for -m flag
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -m|--message)
        message="$2"
        shift 2
        ;;
      *)
        shift
        ;;
    esac
  done

  check_api
  load_env

  if [[ ! -f .golem/IMPLEMENTATION_PLAN.md ]]; then
    die "No implementation plan found"
  fi

  echo -e "${BOLD}Squashing commits for $ticket_id${NC}"
  echo ""

  local commits
  commits=$(git log --oneline origin/main..HEAD 2>/dev/null | wc -l | tr -d ' ')
  echo "Commits to squash: $commits"

  if [[ "$commits" -eq 0 ]]; then
    warn "No commits to squash"
    return 0
  fi

  # If message not provided via flag, prompt interactively
  if [[ -z "$message" ]]; then
    echo ""
    read -p "Commit message: " message
    [[ -z "$message" ]] && die "Commit message required"
  fi

  info "Squashing..."
  $GOLEM_API git:squash "$ticket_id" -m "$message"

  success "Squashed to single commit"
}

cmd_sync() {
  local ticket_id
  ticket_id=$(get_current_ticket)
  [[ -z "$ticket_id" ]] && die "Not in a ticket worktree"

  check_api
  load_env

  local repo="${GITEA_REPO:-}"
  [[ -z "$repo" ]] && die "GITEA_REPO not set"

  read -p "Status (new/spec/planning/in-progress/review/done/blocked): " status
  read -p "Note (optional): " note

  info "Syncing..."
  $GOLEM_API ticket:status "$ticket_id" "$status" --repo "$repo" ${note:+--note "$note"}
}

cmd_pr() {
  local ticket_id
  ticket_id=$(get_current_ticket)
  [[ -z "$ticket_id" ]] && die "Not in a ticket worktree"

  check_api
  load_env

  # Push branch first
  info "Pushing branch..."
  $GOLEM_API git:push "$ticket_id"

  # Get ticket info for PR title/body
  local ticket_json
  ticket_json=$($GOLEM_API ticket:get "$ticket_id" 2>/dev/null)

  local subject
  subject=$(echo "$ticket_json" | grep -o '"subject":"[^"]*"' | cut -d'"' -f4 || echo "$ticket_id")

  local branch
  branch=$(git rev-parse --abbrev-ref HEAD)

  info "Creating PR..."

  # Use gh CLI
  gh pr create \
    --title "[$ticket_id] $subject" \
    --body "Closes Gitea issue.

---
Ticket: $ticket_id
Branch: $branch" \
    --head "$branch"

  # Update status
  local repo="${GITEA_REPO:-}"
  [[ -n "$repo" ]] && $GOLEM_API ticket:status "$ticket_id" "review" --repo "$repo" --note "PR created"

  success "PR created"
}

# Resolve the package root from this script's location.
# When run via pnpm dlx, $0 lives inside a temp store.
# When run from ~/.golem/lib, $0 is there.
_resolve_pkg_root() {
  local script_path
  script_path="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  # bin/ is one level under package root
  echo "$(cd "$script_path/.." && pwd)"
}

# Bootstrap: copy package contents into ~/.golem/lib and wire everything up.
cmd_bootstrap() {
  local pkg_root
  pkg_root="$(_resolve_pkg_root)"

  print_banner
  info "Installing golem to $GOLEM_HOME..."

  # ---- runtime ----
  mkdir -p "$GOLEM_HOME/lib"
  # Copy the package runtime (bin, dist, node_modules, package.json)
  for item in bin dist node_modules package.json; do
    if [[ -e "$pkg_root/$item" ]]; then
      rm -rf "$GOLEM_HOME/lib/$item"
      cp -R "$pkg_root/$item" "$GOLEM_HOME/lib/$item"
    fi
  done
  success "Installed runtime to $GOLEM_HOME/lib"

  # ---- assets ----
  mkdir -p "$GOLEM_HOME"/{commands,agents,prompts}
  if [[ -d "$pkg_root/commands/golem" ]]; then
    rm -rf "$GOLEM_HOME/commands/golem"
    cp -R "$pkg_root/commands/golem" "$GOLEM_HOME/commands/golem"
  fi
  if compgen -G "$pkg_root/golem/agents/"*.md &>/dev/null; then
    cp "$pkg_root/golem/agents/"*.md "$GOLEM_HOME/agents/"
  fi
  if compgen -G "$pkg_root/golem/prompts/"*.md &>/dev/null; then
    cp "$pkg_root/golem/prompts/"*.md "$GOLEM_HOME/prompts/"
  fi
  success "Installed assets (commands, agents, prompts)"

  # ---- symlinks in ~/.local/bin ----
  mkdir -p "$HOME/.local/bin"
  ln -sf "$GOLEM_HOME/lib/bin/golem" "$HOME/.local/bin/golem"
  ln -sf "$GOLEM_HOME/lib/dist/cli/index.js" "$HOME/.local/bin/golem-api"
  chmod +x "$GOLEM_HOME/lib/bin/golem"
  chmod +x "$GOLEM_HOME/lib/dist/cli/index.js" 2>/dev/null || true
  success "Linked binaries to ~/.local/bin"

  # ---- Claude slash-commands ----
  mkdir -p "$HOME/.claude/commands"
  ln -sf "$GOLEM_HOME/commands/golem" "$HOME/.claude/commands/golem" 2>/dev/null || true
  success "Linked Claude commands"

  # ---- .env template ----
  if [[ -f "$pkg_root/.env.example" ]]; then
    cp "$pkg_root/.env.example" "$GOLEM_HOME/.env.example"
  fi
  if [[ ! -f "$GOLEM_HOME/.env" ]]; then
    if [[ -f "$GOLEM_HOME/.env.example" ]]; then
      cp "$GOLEM_HOME/.env.example" "$GOLEM_HOME/.env"
    else
      cat > "$GOLEM_HOME/.env" << 'ENVEOF'
# Freshworks/Freshservice
FRESH_DOMAIN=yourcompany.freshservice.com
FRESH_API_KEY=your_api_key_here

# Gitea (on-prem)
GITEA_URL=https://dev.pearlriverresort.com
GITEA_TOKEN=your_token_here
GITEA_ORG=CRDE

# Default repo for issues (can be overridden per-project)
GITEA_REPO=
ENVEOF
    fi
    warn "Created $GOLEM_HOME/.env — edit with your credentials"
  fi

  # ---- PATH setup (idempotent) ----
  local shell_rc="$HOME/.zshrc"
  [[ -f "$HOME/.bashrc" && ! -f "$HOME/.zshrc" ]] && shell_rc="$HOME/.bashrc"

  if [[ -f "$shell_rc" ]]; then
    if ! grep -q '$HOME/.local/bin' "$shell_rc" 2>/dev/null; then
      echo '' >> "$shell_rc"
      echo '# golem: add ~/.local/bin to PATH' >> "$shell_rc"
      echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$shell_rc"
      success "Added ~/.local/bin to PATH in $(basename "$shell_rc")"
    fi
  fi

  echo ""
  success "Installation complete!"
  echo ""
  echo "Restart your shell (or run: source $shell_rc), then:"
  echo "  golem doctor     # verify setup"
  echo "  golem config     # show configuration"
  echo "  cd <project> && golem init   # set up a project"
}

cmd_uninstall() {
  print_banner
  echo -e "${BOLD}This will remove:${NC}"
  echo "  $GOLEM_HOME              (runtime, assets, config)"
  echo "  ~/.local/bin/golem       (symlink)"
  echo "  ~/.local/bin/golem-api   (symlink)"
  echo "  ~/.claude/commands/golem (symlink)"
  echo ""

  # Check for .env with real credentials and warn
  if [[ -f "$GOLEM_HOME/.env" ]]; then
    warn "Your credentials in $GOLEM_HOME/.env will be deleted."
    echo "  Back up now if needed: cp $GOLEM_HOME/.env ~/golem-env-backup"
    echo ""
  fi

  read -p "Are you sure? [y/N] " confirm
  [[ "$confirm" != "y" && "$confirm" != "Y" ]] && { echo "Aborted."; exit 0; }

  # Remove symlinks in ~/.local/bin
  for bin in golem golem-api; do
    local target="$HOME/.local/bin/$bin"
    if [[ -L "$target" || -f "$target" ]]; then
      rm -f "$target"
      success "Removed $target"
    fi
  done

  # Remove Claude commands symlink
  if [[ -L "$HOME/.claude/commands/golem" || -d "$HOME/.claude/commands/golem" ]]; then
    rm -rf "$HOME/.claude/commands/golem"
    success "Removed ~/.claude/commands/golem"
  fi

  # Remove ~/.golem entirely
  if [[ -d "$GOLEM_HOME" ]]; then
    rm -rf "$GOLEM_HOME"
    success "Removed $GOLEM_HOME"
  fi

  echo ""
  success "Golem uninstalled."
  echo ""
  dim "The PATH entry in your shell rc was left in place (it's harmless)."
  dim "To reinstall later: pnpm dlx golem-cc"
}

cmd_install() {
  # If --from <path> given, bootstrap from a local checkout (dev workflow)
  if [[ "${1:-}" == "--from" ]]; then
    local local_path="${2:-}"
    [[ -z "$local_path" ]] && die "Usage: golem install --from <path>"
    [[ ! -d "$local_path/bin" ]] && die "Not a golem package directory: $local_path"

    # Temporarily override _resolve_pkg_root
    _resolve_pkg_root() { echo "$local_path"; }
    cmd_bootstrap
    return
  fi

  print_banner
  info "Updating golem via pnpm dlx..."
  echo ""

  # Re-run pnpm dlx golem-cc which will hit the bootstrap path
  pnpm dlx golem-cc || die "Update failed"
}

cmd_config() {
  print_banner
  load_env

  echo -e "${BOLD}Configuration${NC}"
  echo ""

  # Paths
  echo -e "${BOLD}Paths${NC}"
  echo "  GOLEM_HOME: $GOLEM_HOME"
  echo ""

  # Env files
  echo -e "${BOLD}Environment Files${NC}"
  if [[ -f "$GOLEM_HOME/.env" ]]; then
    success "$GOLEM_HOME/.env"
  else
    warn "$GOLEM_HOME/.env (not found)"
  fi
  if [[ -f ".env" ]]; then
    success "./.env (local)"
  else
    dim "  ./.env (not found)"
  fi
  echo ""

  # Helper to print var status
  print_var() {
    local name="$1"
    local value="$2"
    local required="$3"
    local secret="$4"

    if [[ -n "$value" ]]; then
      if [[ "$secret" == "true" ]]; then
        echo -e "  ${GREEN}$name${NC}: (set)"
      else
        echo -e "  ${GREEN}$name${NC}: $value"
      fi
    elif [[ "$required" == "true" ]]; then
      echo -e "  ${RED}$name${NC}: (not set) - REQUIRED"
    else
      echo -e "  ${YELLOW}$name${NC}: (not set)"
    fi
  }

  # Freshservice vars
  echo -e "${BOLD}Freshservice${NC}"
  print_var "FRESH_DOMAIN" "${FRESH_DOMAIN:-}" "true" "false"
  print_var "FRESH_API_KEY" "${FRESH_API_KEY:-}" "true" "true"
  print_var "FRESH_DEFAULT_GROUP_ID" "${FRESH_DEFAULT_GROUP_ID:-}" "false" "false"
  print_var "FRESH_DEFAULT_CATEGORY" "${FRESH_DEFAULT_CATEGORY:-}" "false" "false"
  print_var "FRESH_SOURCE_ID" "${FRESH_SOURCE_ID:-}" "false" "false"
  print_var "FRESH_DEFAULT_EMAIL" "${FRESH_DEFAULT_EMAIL:-}" "false" "false"
  echo ""

  # Gitea vars
  echo -e "${BOLD}Gitea${NC}"
  print_var "GITEA_URL" "${GITEA_URL:-}" "true" "false"
  print_var "GITEA_TOKEN" "${GITEA_TOKEN:-}" "true" "true"
  print_var "GITEA_ORG" "${GITEA_ORG:-}" "false" "false"
  print_var "GITEA_REPO" "${GITEA_REPO:-}" "false" "false"
}

cmd_doctor() {
  local check_apis=false
  [[ "${1:-}" == "--check-apis" ]] && check_apis=true

  print_banner
  load_env

  local passed=0
  local failed=0

  # Helper functions
  check_pass() {
    echo -e "  ${GREEN}✓${NC} $1"
    passed=$((passed + 1))
  }

  check_fail() {
    echo -e "  ${RED}✗${NC} $1"
    if [[ -n "${2:-}" ]]; then
      echo -e "    ${DIM}→ $2${NC}"
    fi
    failed=$((failed + 1))
  }

  # Environment checks
  echo -e "${BOLD}Environment${NC}"

  if [[ -d "$GOLEM_HOME" ]]; then
    check_pass "$GOLEM_HOME directory exists"
  else
    check_fail "$GOLEM_HOME directory missing" "Run: mkdir -p $GOLEM_HOME"
  fi

  if [[ -f "$GOLEM_HOME/.env" ]]; then
    check_pass "$GOLEM_HOME/.env file exists"
  else
    check_fail "$GOLEM_HOME/.env file missing" "Run: cp $GOLEM_HOME/.env.example $GOLEM_HOME/.env"
  fi

  local missing_vars=()
  [[ -z "${FRESH_DOMAIN:-}" ]] && missing_vars+=("FRESH_DOMAIN")
  [[ -z "${FRESH_API_KEY:-}" ]] && missing_vars+=("FRESH_API_KEY")
  [[ -z "${GITEA_URL:-}" ]] && missing_vars+=("GITEA_URL")
  [[ -z "${GITEA_TOKEN:-}" ]] && missing_vars+=("GITEA_TOKEN")

  if [[ ${#missing_vars[@]} -eq 0 ]]; then
    check_pass "Required env vars set"
  else
    check_fail "Missing required env vars: ${missing_vars[*]}" "Edit $GOLEM_HOME/.env"
  fi

  echo ""

  # Dependency checks
  echo -e "${BOLD}Dependencies${NC}"

  if command -v node &>/dev/null; then
    local node_ver=$(node --version 2>/dev/null)
    check_pass "node $node_ver"
  else
    check_fail "node not found" "Install Node.js"
  fi

  if command -v pnpm &>/dev/null; then
    local pnpm_ver=$(pnpm --version 2>/dev/null)
    check_pass "pnpm $pnpm_ver"
  else
    check_fail "pnpm not found" "Run: npm install -g pnpm"
  fi

  if command -v git &>/dev/null; then
    local git_ver=$(git --version 2>/dev/null | cut -d' ' -f3)
    check_pass "git $git_ver"
  else
    check_fail "git not found" "Install git"
  fi

  if command -v golem-api &>/dev/null; then
    check_pass "golem-api accessible"
  else
    check_fail "golem-api not found" "Run: pnpm dlx golem-cc"
  fi

  echo ""

  # Installation checks
  echo -e "${BOLD}Installation${NC}"

  if [[ -d "$GOLEM_HOME/lib" ]]; then
    check_pass "Runtime installed ($GOLEM_HOME/lib)"
  else
    check_fail "Runtime not installed" "Run: pnpm dlx golem-cc"
  fi

  local prompt_count=$(ls "$GOLEM_HOME/prompts/"*.md 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$prompt_count" -gt 0 ]]; then
    check_pass "Prompts installed ($prompt_count files)"
  else
    check_fail "No prompts installed" "Run: pnpm dlx golem-cc"
  fi

  local agent_count=$(ls "$GOLEM_HOME/agents/"*.md 2>/dev/null | wc -l | tr -d ' ')
  if [[ "$agent_count" -gt 0 ]]; then
    check_pass "Agents installed ($agent_count files)"
  else
    check_fail "No agents installed" "Run: pnpm dlx golem-cc"
  fi

  if [[ -d "$GOLEM_HOME/commands/golem" ]]; then
    check_pass "Commands installed"
  else
    check_fail "Commands not installed" "Run: pnpm dlx golem-cc"
  fi

  if [[ -L "$HOME/.claude/commands/golem" ]] && [[ -d "$HOME/.claude/commands/golem" ]]; then
    check_pass "Claude integration linked"
  else
    check_fail "Claude integration not linked" "Run: ln -sf $GOLEM_HOME/commands/golem ~/.claude/commands/golem"
  fi

  echo ""

  # Optional API checks
  if [[ "$check_apis" == "true" ]]; then
    echo -e "${BOLD}API Connectivity${NC}"

    if golem-api fresh:test &>/dev/null; then
      check_pass "Freshservice API responds"
    else
      check_fail "Freshservice API not responding" "Check FRESH_DOMAIN and FRESH_API_KEY"
    fi

    if golem-api gitea:test &>/dev/null; then
      check_pass "Gitea API responds"
    else
      check_fail "Gitea API not responding" "Check GITEA_URL and GITEA_TOKEN"
    fi

    echo ""
  fi

  # Summary
  local total=$((passed + failed))
  if [[ "$failed" -eq 0 ]]; then
    echo -e "${GREEN}Summary: $passed/$total checks passed${NC}"
    return 0
  else
    echo -e "${RED}Summary: $passed/$total checks passed ($failed failed)${NC}"
    return 1
  fi
}

# ============================================================================
# Main
# ============================================================================

main() {
  local cmd="${1:-}"
  shift || true

  # No args: bootstrap if not installed, otherwise show help
  if [[ -z "$cmd" ]]; then
    if [[ -d "$GOLEM_HOME/lib" ]]; then
      cmd_help
    else
      cmd_bootstrap
    fi
    return
  fi

  case "$cmd" in
    help|--help|-h)
      cmd_help
      ;;
    version|--version|-v)
      cmd_version
      ;;
    init)
      cmd_init "$@"
      ;;
    new)
      cmd_new "$@"
      ;;
    import)
      cmd_import "$@"
      ;;
    list)
      cmd_list "$@"
      ;;
    status)
      cmd_status "$@"
      ;;
    worktree)
      cmd_worktree "$@"
      ;;
    worktrees)
      cmd_worktrees "$@"
      ;;
    build)
      cmd_build "$@"
      ;;
    plan)
      cmd_plan "$@"
      ;;
    simplify)
      cmd_simplify "$@"
      ;;
    squash)
      cmd_squash "$@"
      ;;
    sync)
      cmd_sync "$@"
      ;;
    pr)
      cmd_pr "$@"
      ;;
    config)
      cmd_config "$@"
      ;;
    doctor)
      cmd_doctor "$@"
      ;;
    install)
      cmd_install "$@"
      ;;
    uninstall)
      cmd_uninstall "$@"
      ;;
    *)
      die "Unknown command: $cmd. Run 'golem help' for usage."
      ;;
  esac
}

main "$@"
